
# 实现计划：AOT 原生编译功能

## 概述

本计划将 AOT 编译功能分解为可执行的编码任务，从基础设施开始，逐步构建完整的编译流水线。

## 任务

- [x] 1. 运行时库完善和编译支持
  - [x] 1.1 完善运行时库算术运算函数
    - 在 `src/aot/runtime_lib.zig` 中添加 `php_add`, `php_sub`, `php_mul`, `php_div`, `php_mod` 函数
    - 实现 PHP 类型转换语义（数字与字符串混合运算）
    - _需求: 5.2, 1.4_
  - [x] 1.2 完善运行时库比较运算函数
    - 添加 `php_eq`, `php_ne`, `php_lt`, `php_le`, `php_gt`, `php_ge` 函数
    - 实现 PHP 松散比较和严格比较语义
    - _需求: 5.2_
  - [x] 1.3 完善运行时库字符串操作函数
    - 添加 `php_string_concat` 函数
    - 添加基本字符串函数：`strlen`, `substr`, `strpos`
    - _需求: 5.7_
  - [ ]* 1.4 编写运行时库属性测试
    - **Property 3: 引用计数正确性**
    - **验证: 需求 2.5**
  - [x] 1.5 添加 build.zig 运行时库编译目标
    - 添加 `build-runtime` 目标，编译 runtime_lib.zig 为静态库
    - 支持多目标平台编译
    - _需求: 2.2, 2.3, 9.1_

- [x] 2. Zig 代码生成器实现
  - [x] 2.1 创建 ZigCodeGenerator 基础结构
    - 创建 `src/aot/zig_codegen.zig` 文件
    - 实现基本的代码输出和缩进管理
    - 实现运行时库导入生成
    - _需求: 1.1_
  - [x] 2.2 实现常量和变量代码生成
    - 实现 `const_int`, `const_float`, `const_bool`, `const_string`, `const_null` 指令
    - 实现变量声明和赋值代码生成
    - _需求: 1.2, 5.1_
  - [x] 2.3 实现算术和逻辑运算代码生成
    - 实现 `add`, `sub`, `mul`, `div`, `mod` 指令到运行时函数调用
    - 实现比较运算指令
    - 实现逻辑运算指令
    - _需求: 1.2, 1.4, 5.2_
  - [x] 2.4 实现控制流代码生成
    - 实现 `branch`, `cond_branch` 终结器
    - 实现 if/else 结构生成
    - 实现 while/for 循环结构生成
    - _需求: 1.5, 5.3_
  - [x] 2.5 实现函数调用代码生成
    - 实现 `call` 指令到函数调用
    - 实现内置函数调用（echo, print, count 等）
    - 实现用户定义函数调用
    - _需求: 1.3, 5.4, 5.5_
  - [x] 2.6 实现数组操作代码生成
    - 实现 `array_new`, `array_get`, `array_set`, `array_push` 指令
    - 实现 foreach 循环代码生成
    - _需求: 5.6_
  - [x] 2.7 实现 main 入口函数生成
    - 生成 Zig main 函数
    - 初始化和清理运行时
    - 调用 PHP 主程序
    - _需求: 4.1_
  - [ ]* 2.8 编写代码生成器属性测试
    - **Property 2: IR 到 Zig 代码的语法正确性**
    - **验证: 需求 1.1, 1.2**

- [x] 3. 检查点 - 代码生成验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 4. 链接器实现
  - [x] 4.1 实现 ZigLinker 基础结构
    - 修改 `src/aot/linker.zig`，添加 Zig 编译器调用逻辑
    - 实现临时文件管理
    - _需求: 3.1_
  - [x] 4.2 实现 Zig 编译命令构建
    - 构建正确的 `zig build-exe` 命令
    - 支持优化级别选项
    - 支持目标平台选项
    - _需求: 3.4, 6.1-6.4, 7.1-7.4_
  - [x] 4.3 实现静态链接支持
    - 添加运行时库链接
    - 支持 --static 选项
    - _需求: 3.2_
  - [x] 4.4 实现输出文件名处理
    - 支持 --output 选项
    - 默认从输入文件名派生
    - _需求: 3.5_
  - [x] 4.5 编写链接器属性测试
    - **Property 7: 输出文件名正确性**
    - **验证: 需求 3.5**

- [x] 5. 编译器流水线集成
  - [x] 5.1 修改 AOTCompiler 集成 ZigCodeGenerator
    - 在 `src/aot/compiler.zig` 中集成新的代码生成器
    - 替换原有的 LLVM 代码生成调用
    - _需求: 4.1_
  - [x] 5.2 修改 AOTCompiler 集成 ZigLinker
    - 集成新的链接器
    - 实现完整的编译流水线
    - _需求: 4.1_
  - [x] 5.3 实现编译错误处理
    - 捕获 Zig 编译器错误
    - 转换为用户友好的错误信息
    - _需求: 8.1-8.4_
  - [x] 5.4 实现 verbose 和 dump 选项
    - 实现 --verbose 详细输出
    - 实现 --dump-ir 和 --dump-ast
    - 添加 --dump-zig 选项显示生成的 Zig 代码
    - _需求: 4.4, 4.5_

- [x] 6. 检查点 - 基本编译功能验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 7. main.zig 集成
  - [x] 7.1 修改 runAOTCompilation 函数
    - 调用新的编译流水线
    - 生成实际的可执行文件
    - _需求: 4.1_
  - [x] 7.2 添加 --dump-zig 命令行选项
    - 显示生成的 Zig 源代码
    - 用于调试和学习
    - _需求: 4.5_

- [x] 8. 端到端测试
  - [x] 8.1 创建基本编译测试
    - 测试简单的 echo 语句
    - 测试变量赋值和输出
    - _需求: 4.1, 5.1, 5.5_
  - [x] 8.2 创建算术运算测试
    - 测试各种算术运算
    - 测试类型转换
    - _需求: 5.2_
  - [x] 8.3 创建控制流测试
    - 测试 if/else
    - 测试 while/for 循环
    - 测试 foreach
    - _需求: 5.3_
  - [x] 8.4 创建函数测试
    - 测试用户定义函数
    - 测试递归函数
    - _需求: 5.4_
  - [x] 8.5 创建数组测试
    - 测试数组创建和访问
    - 测试关联数组
    - _需求: 5.6_
  - [x] 8.6 编写端到端属性测试
    - **Property 1: 编译输出等价性**
    - **验证: 需求 4.2, 5.1-5.7**

- [x] 9. 检查点 - 端到端功能验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 10. 跨平台支持
  - [x] 10.1 测试 Linux x86_64 目标
    - 验证交叉编译功能
    - _需求: 7.1_
  - [x] 10.2 测试 Linux ARM64 目标
    - 验证交叉编译功能
    - _需求: 7.2_
  - [x] 10.3 测试 macOS 目标
    - 验证 macOS x86_64 和 ARM64
    - _需求: 7.3, 7.4_
  - [x] 10.4 更新 --list-targets 输出
    - 确保显示所有支持的目标
    - _需求: 7.5_

- [x] 11. 优化支持
  - [x] 11.1 实现优化级别传递
    - 将优化级别传递给 Zig 编译器
    - debug → -ODebug
    - release-safe → -OReleaseSafe
    - release-fast → -OReleaseFast
    - release-small → -OReleaseSmall
    - _需求: 6.1-6.4_
  - [x] 11.2 验证 IR 优化器集成
    - 确保 IR 优化在代码生成前执行
    - _需求: 6.5_

- [x] 12. 文档和示例
  - [x] 12.1 更新用户文档
    - 添加 AOT 编译使用说明
    - 添加命令行选项说明
    - _需求: 4.4, 4.5_
  - [x] 12.2 创建示例程序
    - 创建可编译的示例 PHP 文件
    - 添加编译和运行说明
    - _需求: 4.1_

- [ ] 13. 最终检查点
  - 确保所有测试通过，如有问题请询问用户

- [x] 14. AOT 编译器问题修复
  - [x] 14.1 实现变量存储和加载指令
    - 在 `src/aot/zig_codegen.zig` 中实现 `alloca`, `store`, `load` 指令的代码生成
    - 使用 Zig 变量来模拟栈分配
    - 确保变量赋值和读取正确工作
    - _需求: 5.1, 1.2_
  - [x] 14.2 修复内置函数调用生成
    - 修复 `echo` 等内置函数的调用生成（当前生成 `php_php_echo` 应为 `runtime.php_echo`）
    - 确保所有内置函数调用使用正确的 runtime 前缀
    - _需求: 5.5_
  - [x] 14.3 修复字符串常量生成
    - 修复字符串中的乱码问题
    - 确保字符串正确转义和编码
    - _需求: 5.7_
  - [x] 14.4 修复内存泄漏问题
    - 在 `src/main.zig` 的 `runAOTCompilation` 函数中修复内存泄漏
    - 确保所有分配的内存都被正确释放
    - 使用 Zig 的 GeneralPurposeAllocator 检测泄漏
    - _需求: 8.1_

- [x] 15. AOT 编译验证
  - [x] 15.1 验证基本 PHP 脚本编译
    - 确保 `examples/aot_hello.php` 能够成功编译并运行
    - 验证输出与解释器模式一致
    - _需求: 4.2_
  - [x] 15.2 验证函数编译
    - 确保 `examples/aot_functions.php` 能够成功编译并运行
    - 验证递归函数正确工作
    - 注意: 需要修复函数参数处理和控制流生成
    - _需求: 5.4_
  - [x] 15.3 验证数组编译
    - 确保 `examples/aot_arrays.php` 能够成功编译并运行
    - 验证数组操作正确工作
    - 注意: 编译成功但运行时有内存泄漏
    - _需求: 5.6_
  - [x] 15.4 验证控制流编译
    - 确保 `examples/aot_control_flow.php` 能够成功编译并运行
    - 验证所有控制流结构正确工作
    - 注意: 已修复嵌套循环中的控制流生成
    - 注意: foreach 循环有已知问题（IR 生成问题，不是代码生成器问题）
    - _需求: 5.3_

- [ ] 16. 最终验证检查点
  - 确保 AOT 编译功能完全正常工作
  - 验证解释器和 AOT 编译输出一致性
  - [x] 确保无内存泄漏

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点任务用于验证阶段性成果
- 属性测试验证通用的正确性属性
- 单元测试验证具体的示例和边界情况
